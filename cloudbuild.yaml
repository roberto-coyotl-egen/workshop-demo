steps:
  # =====================================================
  # STAGE 1: QUALITY GATE (Run the Tests)
  # =====================================================
  - name: 'python:3.11'
    id: 'run-eval-tests'
    entrypoint: 'bash'
    env:
      - 'GCP_PROJECT_ID=$PROJECT_ID'  # <--- Passes ID to the Test Runner
    args:
      - '-c'
      - |
        echo "ðŸ”¹ [Stage 1] Installing Dependencies..."
        pip install -r requirements.txt

        echo "ðŸ”¹ [Stage 1] Running Evaluation Loop..."
        python3 tests/evaluate.py

  # =====================================================
  # STAGE 2: BUILD & DEPLOY (Only if Stage 1 passes)
  # =====================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-agent'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - 'brady-logistics-agent'
      - '--source=.'
      - '--region=us-central1'
      - '--allow-unauthenticated'
      # ---------------------------------------------------
      # CRITICAL FIX: Pass the Project ID to the live app
      # ---------------------------------------------------
      - '--set-env-vars=GCP_PROJECT_ID=$PROJECT_ID'
    
    waitFor: ['run-eval-tests']

timeout: '600s'